<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>æ³°ç²¤åŒè¯­åŠ©æ‰‹ v8.2 (åŒå¼•æ“ä¿®å¤ç‰ˆ)</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@picocss/pico@1/css/pico.min.css">
    <style>
        :root { --primary: #00897b; --bg-light: #e0f2f1; }
        body { padding: 15px; max-width: 600px; margin: 0 auto; padding-bottom: 100px; touch-action: manipulation; }
        
        .lang-switcher { display: flex; gap: 10px; margin-bottom: 20px; background: #eee; padding: 4px; border-radius: 50px; }
        .lang-btn { flex: 1; border: none; background: transparent; color: #666; border-radius: 40px; font-size: 0.9rem; padding: 8px; cursor: pointer; transition: all 0.2s; }
        .lang-btn.active { background: white; color: var(--primary); font-weight: bold; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }

        .header-tools { display: flex; gap: 8px; align-items: center; margin-bottom: 15px; flex-wrap: wrap; }
        .header-tools select { margin: 0; flex-grow: 1; border-color: #ddd; height: auto; padding: 8px; }
        .header-tools button { width: auto; padding: 6px 12px; font-size: 0.8rem; margin: 0; border-radius: 20px; background: white; color: var(--primary); border: 1px solid var(--primary); }
        .header-tools button.active { background: var(--primary); color: white; }

        .word-item { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; padding: 12px 15px; border: 1px solid #eee; border-radius: 12px; background: white; box-shadow: 0 2px 4px rgba(0,0,0,0.02); transition: 0.2s; }
        .word-item.known { opacity: 0.5; background: #f9f9f9; filter: grayscale(0.8); }
        
        .main-text { font-size: 1.3rem; font-weight: bold; color: var(--primary); margin-bottom: 2px; }
        .sub-text { font-size: 0.85rem; color: #f57c00; font-family: monospace; }
        .mean-text { color: #555; font-size: 0.95rem; margin-top: 2px; }
        .hide-mode .mean-text { background-color: #e0e0e0; color: transparent; border-radius: 4px; user-select: none; }
        .hide-mode .mean-text:active { background-color: #fff3cd; color: #555; }

        .cloud-panel { background: var(--bg-light); padding: 15px; border-radius: 12px; margin-top: 30px; font-size: 0.9rem; border: 1px solid rgba(0,0,0,0.05); }
        .btn-action { padding: 4px 10px; font-size: 0.8rem; margin-left: 5px; background: #f5f5f5; color: #666; border: none; border-radius: 6px; }
    </style>
</head>
<body>

    <main>
        <div class="lang-switcher">
            <button class="lang-btn" id="btn-th" onclick="switchLang('th')">ğŸ‡¹ğŸ‡­ æ³°è¯­æ¨¡å¼</button>
            <button class="lang-btn" id="btn-hk" onclick="switchLang('hk')">ğŸ‡­ğŸ‡° ç²¤è¯­æ¨¡å¼</button>
        </div>

        <h3 id="appTitle" style="margin-bottom: 15px; color: var(--primary);">æ³°è¯­å­¦ä¹ </h3>

        <div class="header-tools">
            <select id="categorySelect" onchange="changeCategory()"></select>
            <button onclick="addCategory()">+ ç›®å½•</button>
            <button id="modeBtn" onclick="toggleMode()">ğŸ‘ï¸ èƒŒè¯µ</button>
            <button id="filterBtn" onclick="toggleFilter()">âœ… è¿‡æ»¤</button>
        </div>

        <details open>
            <summary style="color:var(--primary); font-weight:bold; cursor:pointer;">â• æ·»åŠ å•è¯ / è‡ªåŠ¨ç¿»è¯‘</summary>
            <div class="grid">
                <input type="text" id="inpMain" placeholder="åŸæ–‡" onkeypress="handleEnter(event)">
                <input type="text" id="inpSub" placeholder="æ³¨éŸ³ (é€‰å¡«)" onkeypress="handleEnter(event)">
                <input type="text" id="inpMean" placeholder="ä¸­æ–‡å«ä¹‰ (ç•™ç©ºç¿»è¯‘)" onkeypress="handleEnter(event)">
            </div>
            <button id="addBtn" onclick="addWord()" style="background:var(--primary); border:none;">æ·»åŠ </button>
        </details>

        <div style="text-align: right; font-size: 0.8rem; color: #888; margin: 10px 0;">
            <span id="countDisplay">0</span> è¯
        </div>

        <div id="wordList"></div>

        <div class="cloud-panel">
            <details>
                <summary>â˜ï¸ <b>äº‘åŒæ­¥ / é¢„ç½®æ•°æ®</b></summary>
                <div style="margin-top: 10px; border-bottom: 1px solid #ccc; padding-bottom: 10px; margin-bottom: 10px;">
                    <button class="outline contrast" onclick="importSeedData()" style="width:100%">ğŸš€ å¯¼å…¥æ•‘å‘½å£è¯­ (å½“å‰è¯­è¨€)</button>
                </div>
                <label>GitHub Token:</label>
                <input type="password" id="ghToken" placeholder="ghp_xxxx..." onchange="saveCloudConfig()">
                <label>Gist ID:</label>
                <input type="text" id="ghGistId" placeholder="è‡ªåŠ¨ç”Ÿæˆ..." onchange="saveCloudConfig()">
                <div class="grid">
                    <button onclick="syncToCloud()" style="background:#1e88e5; border:none;">â¬†ï¸ ä¸Šä¼ </button>
                    <button onclick="syncFromCloud()" style="background:#fb8c00; border:none;">â¬‡ï¸ ä¸‹è½½</button>
                </div>
                <small id="syncStatus" style="display:block; text-align:right; margin-top:5px; color:#666;">æœªåŒæ­¥</small>
            </details>
        </div>
    </main>

    <script>
        // é…ç½®ï¼šå¢åŠ  googleSrc (Google API æºè¯­è¨€ä»£ç )
        const CONFIG = {
            'th': { name: 'ğŸ‡¹ğŸ‡­ æ³°è¯­', storeKey: 'thaiData', color: '#00897b', bg: '#e0f2f1', tts: 'th-TH', googleSrc: 'th', mymemSrc: 'th', file: 'thai.json', seed: [{t:"à¸ªà¸§à¸±à¸ªà¸”à¸µ", s:"Sa-wat-dee", m:"ä½ å¥½", c:"æ—¥å¸¸"}] },
            'hk': { name: 'ğŸ‡­ğŸ‡° ç²¤è¯­', storeKey: 'cantoneseData', color: '#d81b60', bg: '#fce4ec', tts: 'zh-HK', googleSrc: 'auto', mymemSrc: 'zh-HK', file: 'cantonese.json', seed: [{t:"å””è¯¥", s:"m4 goi1", m:"è°¢è°¢", c:"æ—¥å¸¸"}] }
        };

        let currLang = localStorage.getItem('lastLang') || 'th';
        let appData = { cats: ['é»˜è®¤'], words: [] };
        let currCat = 'é»˜è®¤';
        let cloudCfg = { token: '', gistId: '' };
        let isHide = false;
        let isFilter = false;

        function init() {
            const c = localStorage.getItem('cloudCfg');
            if (c) {
                try { cloudCfg = JSON.parse(c); } catch(e){}
                document.getElementById('ghToken').value = cloudCfg.token || '';
                document.getElementById('ghGistId').value = cloudCfg.gistId || '';
            }
            switchLang(currLang);
        }

        function switchLang(lang) {
            currLang = lang;
            localStorage.setItem('lastLang', lang);
            const cfg = CONFIG[lang];
            
            document.documentElement.style.setProperty('--primary', cfg.color);
            document.documentElement.style.setProperty('--bg-light', cfg.bg);
            document.getElementById('appTitle').innerText = cfg.name + "å­¦ä¹ åŠ©æ‰‹";
            document.getElementById('btn-th').className = lang === 'th' ? 'lang-btn active' : 'lang-btn';
            document.getElementById('btn-hk').className = lang === 'hk' ? 'lang-btn active' : 'lang-btn';

            const raw = localStorage.getItem(cfg.storeKey);
            if (raw) {
                let temp = JSON.parse(raw);
                if (temp.categories) { // å…¼å®¹æ—§ç‰ˆ
                    appData.cats = temp.categories || ['é»˜è®¤'];
                    appData.words = (temp.words||[]).map(w=>({t:w.thai||w.t, m:w.cn||w.m, s:w.rom||w.s, c:w.category||w.c||'é»˜è®¤', k:w.known||w.k||false}));
                    saveData();
                } else {
                    appData = temp;
                }
            } else {
                appData = { cats: ['é»˜è®¤'], words: [] };
            }
            if(!appData.cats || !appData.cats.length) appData.cats = ['é»˜è®¤'];
            if(!appData.cats.includes(currCat)) currCat = appData.cats[0];
            renderCats(); renderList();
        }

        function saveData() { localStorage.setItem(CONFIG[currLang].storeKey, JSON.stringify(appData)); }

        // --- æ ¸å¿ƒï¼šåŒå¼•æ“ç¿»è¯‘å‡½æ•° ---
        async function translateText(text) {
            const cfg = CONFIG[currLang];
            // 1. ä¼˜å…ˆå°è¯• Google GTX (æ›´å¿«æ›´å‡†ï¼Œæ”¯æŒHTTPS)
            try {
                // sl=æºè¯­è¨€, tl=ç›®æ ‡è¯­è¨€(zh-CN)
                const gUrl = `https://translate.googleapis.com/translate_a/single?client=gtx&sl=${cfg.googleSrc}&tl=zh-CN&dt=t&q=${encodeURIComponent(text)}`;
                const res = await fetch(gUrl);
                const data = await res.json();
                if (data && data[0] && data[0][0] && data[0][0][0]) {
                    console.log("Translated via Google");
                    return data[0][0][0];
                }
            } catch (e) {
                console.warn("Google API failed, switching to MyMemory...", e);
            }

            // 2. å¤±è´¥å›é€€ MyMemory
            try {
                const mUrl = `https://api.mymemory.translated.net/get?q=${encodeURIComponent(text)}&langpair=${cfg.mymemSrc}|zh-CN`;
                const res = await fetch(mUrl);
                const data = await res.json();
                if (data.responseData && data.responseData.translatedText) {
                    console.log("Translated via MyMemory");
                    return data.responseData.translatedText;
                }
            } catch (e) {
                console.error("MyMemory API failed", e);
                // æŠ›å‡ºé”™è¯¯ä»¥ä¾¿ UI æ•è·
                throw new Error("ç¿»è¯‘æœåŠ¡è¿æ¥å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œ");
            }
            return null;
        }

        function handleEnter(e) { if(e.key === 'Enter') addWord(); }

        async function addWord() {
            const m = document.getElementById('inpMain').value.trim();
            const s = document.getElementById('inpSub').value.trim();
            let c = document.getElementById('inpMean').value.trim();
            
            if (!m) return alert("è¯·è¾“å…¥å†…å®¹");

            // åªæœ‰å½“ä¸­æ–‡ä¸ºç©ºæ—¶æ‰ç¿»è¯‘
            if (!c) {
                const btn = document.getElementById('addBtn');
                const oldTxt = btn.innerText;
                btn.innerText = "ğŸ”„ ç¿»è¯‘ä¸­...";
                btn.disabled = true; // é˜²æ­¢é‡å¤ç‚¹å‡»
                
                try {
                    const result = await translateText(m);
                    if (result) c = result;
                    else c = "ç¿»è¯‘å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨è¾“å…¥";
                } catch (e) {
                    alert("âš ï¸ è‡ªåŠ¨ç¿»è¯‘å¤±æ•ˆï¼š\nå¯èƒ½æ˜¯ç½‘ç»œé—®é¢˜æˆ–APIé™åˆ¶ã€‚\nè¯·æš‚æ—¶æ‰‹åŠ¨è¾“å…¥ä¸­æ–‡ã€‚");
                } finally {
                    btn.innerText = oldTxt;
                    btn.disabled = false;
                }
            }

            appData.words.push({ t:m, s:s, m:c, c:currCat, k:false });
            saveData();
            
            document.getElementById('inpMain').value = '';
            document.getElementById('inpSub').value = '';
            document.getElementById('inpMean').value = '';
            document.getElementById('inpMain').focus();
            
            renderList();
            speak(m);
        }

        // --- ä»¥ä¸‹ UI é€»è¾‘ä¿æŒä¸å˜ ---
        function renderCats() {
            const sel = document.getElementById('categorySelect'); sel.innerHTML = '';
            appData.cats.forEach(c => {
                const opt = document.createElement('option'); opt.value = c; opt.text = c; sel.appendChild(opt);
            });
            sel.value = currCat;
        }
        function changeCategory() { currCat = document.getElementById('categorySelect').value; renderList(); }
        function addCategory() {
            let n = prompt("æ–°ç›®å½•å:");
            if(n){ n=n.trim(); if(n && !appData.cats.includes(n)){appData.cats.push(n);currCat=n;saveData();renderCats();renderList();}}
        }
        function renderList() {
            const list = document.getElementById('wordList'); list.innerHTML = ''; list.className = isHide ? 'hide-mode' : '';
            let data = appData.words.filter(w => w.c === currCat);
            if(isFilter) data = data.filter(w => !w.k);
            data.sort((a,b) => (a.k===b.k)?0:a.k?1:-1);
            document.getElementById('countDisplay').innerText = data.length;
            data.forEach(item => {
                const div = document.createElement('div');
                div.className = `word-item ${item.k?'known':''}`;
                div.innerHTML = `
                    <div style="flex-grow:1" onclick="speak('${item.t}')">
                        <div class="main-text">${item.t}</div>
                        ${item.s?`<div class="sub-text">[${item.s}]</div>`:''}
                        <div class="mean-text">${item.m}</div>
                    </div>
                    <div style="display:flex;flex-direction:column;gap:5px;">
                        <button class="btn-action" style="${item.k?'background:var(--primary);color:white':''}" onclick="toggleKnown('${item.t}')">âœ”</button>
                        <button class="btn-action" onclick="delWord('${item.t}')">âœ•</button>
                    </div>`;
                list.appendChild(div);
            });
        }
        function toggleKnown(txt) { const w = appData.words.find(x => x.t === txt && x.c === currCat); if(w) { w.k = !w.k; saveData(); renderList(); } }
        function delWord(txt) { if(confirm('åˆ é™¤?')) { const idx = appData.words.findIndex(x => x.t === txt && x.c === currCat); if(idx>-1) { appData.words.splice(idx,1); saveData(); renderList(); } } }
        function toggleMode() { isHide=!isHide; renderList(); document.getElementById('modeBtn').classList.toggle('active'); }
        function toggleFilter() { isFilter=!isFilter; renderList(); document.getElementById('filterBtn').classList.toggle('active'); }
        function speak(t) { const u=new SpeechSynthesisUtterance(t); u.lang=CONFIG[currLang].tts; u.rate=0.85; window.speechSynthesis.speak(u); }
        
        // --- å¯¼å…¥ä¸åŒæ­¥ ---
        function importSeedData() {
            if(!confirm(`å¯¼å…¥${CONFIG[currLang].name}æ•‘å‘½å£è¯­?`)) return;
            const seeds = [{t:"à¸ªà¸§à¸±à¸ªà¸”à¸µ", s:"Sa-wat-dee", m:"ä½ å¥½/å†è§", c:"æ—¥å¸¸"}, {t:"à¸‚à¸­à¸šà¸„à¸¸à¸“", s:"Khob-khun", m:"è°¢è°¢", c:"æ—¥å¸¸"}, {t:"à¹„à¸¡à¹ˆà¹€à¸›à¹‡à¸™à¹„à¸£", s:"Mai-pen-rai", m:"æ²¡å…³ç³»", c:"æ—¥å¸¸"}, {t:"à¹€à¸—à¹ˆà¸²à¹„à¸«à¸£à¹ˆ", s:"Thao-rai", m:"å¤šå°‘é’±", c:"è´­ç‰©"}]; // ç®€åŒ–æ¼”ç¤ºï¼Œå®Œæ•´æ•°æ®å¯è‡ªè¡Œè¡¥å……
            seeds.forEach(s => { if(!appData.cats.includes(s.c)) appData.cats.push(s.c); if(!appData.words.some(w => w.t === s.t)) appData.words.push({t:s.t,s:s.s,m:s.m,c:s.c,k:false}); });
            saveData(); renderCats(); renderList();
        }
        function saveCloudConfig() {
            cloudCfg.token = document.getElementById('ghToken').value.trim();
            cloudCfg.gistId = document.getElementById('ghGistId').value.trim();
            localStorage.setItem('cloudCfg', JSON.stringify(cloudCfg));
        }
        async function syncToCloud() {
            if(!cloudCfg.token) return alert("æ—  Token");
            document.getElementById('syncStatus').innerText = "â³";
            const file = CONFIG[currLang].file;
            const payload = { description: "Thai/Cantonese Backup", public: false, files: { [file]: { content: JSON.stringify(appData) } } };
            let url = "https://api.github.com/gists", method = "POST";
            if(cloudCfg.gistId) { url += "/" + cloudCfg.gistId; method = "PATCH"; }
            try {
                const res = await fetch(url, { method, headers: { "Authorization": `token ${cloudCfg.token}` }, body: JSON.stringify(payload) });
                const d = await res.json();
                if(!cloudCfg.gistId) { cloudCfg.gistId = d.id; document.getElementById('ghGistId').value = d.id; saveCloudConfig(); }
                document.getElementById('syncStatus').innerText = "âœ… OK " + new Date().toLocaleTimeString();
            } catch(e) { alert("Fail"); }
        }
        async function syncFromCloud() {
            if(!cloudCfg.gistId) return alert("æ—  Gist ID");
            document.getElementById('syncStatus').innerText = "â³";
            try {
                const res = await fetch(`https://api.github.com/gists/${cloudCfg.gistId}`, { headers: { "Authorization": `token ${cloudCfg.token}` } });
                const d = await res.json();
                const file = CONFIG[currLang].file;
                if(d.files && d.files[file]) { if(confirm("è¦†ç›–æœ¬åœ°?")) { appData = JSON.parse(d.files[file].content); saveData(); renderCats(); renderList(); document.getElementById('syncStatus').innerText = "âœ… OK"; } } else alert("äº‘ç«¯æ— æ•°æ®");
            } catch(e) { alert("Fail"); }
        }

        init();
    </script>
</body>
</html>
