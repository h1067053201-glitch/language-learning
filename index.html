<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>æ³°ç²¤åŒè¯­åŠ©æ‰‹ v8.1 (ä¿®å¤ç‰ˆ)</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@picocss/pico@1/css/pico.min.css">
    <style>
        :root { --primary: #00897b; --bg-light: #e0f2f1; }
        body { padding: 15px; max-width: 600px; margin: 0 auto; padding-bottom: 100px; touch-action: manipulation; }
        
        /* è¯­è¨€åˆ‡æ¢å™¨ */
        .lang-switcher { display: flex; gap: 10px; margin-bottom: 20px; background: #eee; padding: 4px; border-radius: 50px; }
        .lang-btn { flex: 1; border: none; background: transparent; color: #666; border-radius: 40px; font-size: 0.9rem; padding: 8px; cursor: pointer; transition: all 0.2s; }
        .lang-btn.active { background: white; color: var(--primary); font-weight: bold; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }

        /* å·¥å…·æ  */
        .header-tools { display: flex; gap: 8px; align-items: center; margin-bottom: 15px; flex-wrap: wrap; }
        .header-tools select { margin: 0; flex-grow: 1; border-color: #ddd; height: auto; padding: 8px; }
        .header-tools button { width: auto; padding: 6px 12px; font-size: 0.8rem; margin: 0; border-radius: 20px; background: white; color: var(--primary); border: 1px solid var(--primary); }
        .header-tools button.active { background: var(--primary); color: white; }

        .word-item { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; padding: 12px 15px; border: 1px solid #eee; border-radius: 12px; background: white; box-shadow: 0 2px 4px rgba(0,0,0,0.02); transition: 0.2s; }
        .word-item.known { opacity: 0.5; background: #f9f9f9; filter: grayscale(0.8); }
        
        .main-text { font-size: 1.3rem; font-weight: bold; color: var(--primary); margin-bottom: 2px; }
        .sub-text { font-size: 0.85rem; color: #f57c00; font-family: monospace; }
        .mean-text { color: #555; font-size: 0.95rem; margin-top: 2px; }
        .hide-mode .mean-text { background-color: #e0e0e0; color: transparent; border-radius: 4px; user-select: none; }
        .hide-mode .mean-text:active { background-color: #fff3cd; color: #555; }

        .cloud-panel { background: var(--bg-light); padding: 15px; border-radius: 12px; margin-top: 30px; font-size: 0.9rem; border: 1px solid rgba(0,0,0,0.05); }
        .btn-action { padding: 4px 10px; font-size: 0.8rem; margin-left: 5px; background: #f5f5f5; color: #666; border: none; border-radius: 6px; }
    </style>
</head>
<body>

    <main>
        <div class="lang-switcher">
            <button class="lang-btn" id="btn-th" onclick="switchLang('th')">ğŸ‡¹ğŸ‡­ æ³°è¯­æ¨¡å¼</button>
            <button class="lang-btn" id="btn-hk" onclick="switchLang('hk')">ğŸ‡­ğŸ‡° ç²¤è¯­æ¨¡å¼</button>
        </div>

        <h3 id="appTitle" style="margin-bottom: 15px; color: var(--primary);">æ³°è¯­å­¦ä¹ </h3>

        <div class="header-tools">
            <select id="categorySelect" onchange="changeCategory()"></select>
            <button onclick="addCategory()">+ ç›®å½•</button>
            <button id="modeBtn" onclick="toggleMode()">ğŸ‘ï¸ èƒŒè¯µ</button>
            <button id="filterBtn" onclick="toggleFilter()">âœ… è¿‡æ»¤</button>
        </div>

        <details open>
            <summary style="color:var(--primary); font-weight:bold; cursor:pointer;">â• æ·»åŠ å•è¯ / è‡ªåŠ¨ç¿»è¯‘</summary>
            <div class="grid">
                <input type="text" id="inpMain" placeholder="åŸæ–‡" onkeypress="handleEnter(event)">
                <input type="text" id="inpSub" placeholder="æ³¨éŸ³ (é€‰å¡«)" onkeypress="handleEnter(event)">
                <input type="text" id="inpMean" placeholder="ä¸­æ–‡å«ä¹‰ (ç•™ç©ºç¿»è¯‘)" onkeypress="handleEnter(event)">
            </div>
            <button id="addBtn" onclick="addWord()" style="background:var(--primary); border:none;">æ·»åŠ </button>
        </details>

        <div style="text-align: right; font-size: 0.8rem; color: #888; margin: 10px 0;">
            <span id="countDisplay">0</span> è¯
        </div>

        <div id="wordList"></div>

        <div class="cloud-panel">
            <details>
                <summary>â˜ï¸ <b>äº‘åŒæ­¥ / é¢„ç½®æ•°æ®</b></summary>
                <div style="margin-top: 10px; border-bottom: 1px solid #ccc; padding-bottom: 10px; margin-bottom: 10px;">
                    <button class="outline contrast" onclick="importSeedData()" style="width:100%">ğŸš€ å¯¼å…¥æ•‘å‘½å£è¯­ (å½“å‰è¯­è¨€)</button>
                </div>
                <label>GitHub Token:</label>
                <input type="password" id="ghToken" placeholder="ghp_xxxx..." onchange="saveCloudConfig()">
                <label>Gist ID:</label>
                <input type="text" id="ghGistId" placeholder="è‡ªåŠ¨ç”Ÿæˆ..." onchange="saveCloudConfig()">
                <div class="grid">
                    <button onclick="syncToCloud()" style="background:#1e88e5; border:none;">â¬†ï¸ ä¸Šä¼ </button>
                    <button onclick="syncFromCloud()" style="background:#fb8c00; border:none;">â¬‡ï¸ ä¸‹è½½</button>
                </div>
                <small id="syncStatus" style="display:block; text-align:right; margin-top:5px; color:#666;">æœªåŒæ­¥</small>
            </details>
        </div>
    </main>

    <script>
        const CONFIG = {
            'th': { name: 'ğŸ‡¹ğŸ‡­ æ³°è¯­', storeKey: 'thaiData', color: '#00897b', bg: '#e0f2f1', tts: 'th-TH', trans: 'th|zh-CN', file: 'thai.json', seed: [{t:"à¸ªà¸§à¸±à¸ªà¸”à¸µ", s:"Sa-wat-dee", m:"ä½ å¥½/å†è§", c:"æ—¥å¸¸"}, {t:"à¸‚à¸­à¸šà¸„à¸¸à¸“", s:"Khob-khun", m:"è°¢è°¢", c:"æ—¥å¸¸"}, {t:"à¹„à¸¡à¹ˆà¹€à¸›à¹‡à¸™à¹„à¸£", s:"Mai-pen-rai", m:"æ²¡å…³ç³»", c:"æ—¥å¸¸"}, {t:"à¹€à¸—à¹ˆà¸²à¹„à¸«à¸£à¹ˆ", s:"Thao-rai", m:"å¤šå°‘é’±", c:"è´­ç‰©"}] },
            'hk': { name: 'ğŸ‡­ğŸ‡° ç²¤è¯­', storeKey: 'cantoneseData', color: '#d81b60', bg: '#fce4ec', tts: 'zh-HK', trans: 'zh-HK|zh-CN', file: 'cantonese.json', seed: [{t:"é›·å¥½", s:"lei5 hou2", m:"ä½ å¥½", c:"æ—¥å¸¸"}, {t:"å””è¯¥", s:"m4 goi1", m:"è°¢è°¢/éº»çƒ¦", c:"æ—¥å¸¸"}, {t:"å¤šè°¢", s:"do1 ze6", m:"è°¢è°¢", c:"æ—¥å¸¸"}, {t:"å‡ å¤šé’±", s:"gei2 do1 cin2", m:"å¤šå°‘é’±", c:"è´­ç‰©"}] }
        };

        let currLang = localStorage.getItem('lastLang') || 'th';
        let appData = { cats: ['é»˜è®¤'], words: [] };
        let currCat = 'é»˜è®¤';
        let cloudCfg = { token: '', gistId: '' };
        let isHide = false;
        let isFilter = false;

        function init() {
            const c = localStorage.getItem('cloudCfg');
            if (c) {
                try { cloudCfg = JSON.parse(c); } catch(e){}
                document.getElementById('ghToken').value = cloudCfg.token || '';
                document.getElementById('ghGistId').value = cloudCfg.gistId || '';
            }
            switchLang(currLang);
        }

        // --- æ ¸å¿ƒä¿®å¤é€»è¾‘ ---
        function switchLang(lang) {
            currLang = lang;
            localStorage.setItem('lastLang', lang);
            
            const cfg = CONFIG[lang];
            document.documentElement.style.setProperty('--primary', cfg.color);
            document.documentElement.style.setProperty('--bg-light', cfg.bg);
            document.getElementById('appTitle').innerText = cfg.name + "å­¦ä¹ åŠ©æ‰‹";
            document.getElementById('btn-th').className = lang === 'th' ? 'lang-btn active' : 'lang-btn';
            document.getElementById('btn-hk').className = lang === 'hk' ? 'lang-btn active' : 'lang-btn';

            const raw = localStorage.getItem(cfg.storeKey);
            if (raw) {
                let temp = JSON.parse(raw);
                
                // === è‡ªåŠ¨ä¿®å¤ï¼šæ£€æµ‹æ—§æ•°æ®æ ¼å¼å¹¶è¿ç§» ===
                if (temp.categories) { 
                    // å‘ç°æ—§æ ¼å¼ (categories)ï¼Œè½¬æ¢ä¸ºæ–°æ ¼å¼ (cats)
                    console.log("Migrating legacy data...");
                    appData.cats = temp.categories || ['é»˜è®¤'];
                    appData.words = (temp.words || []).map(w => ({
                        t: w.thai || w.t || '', // å…¼å®¹æ—§ key: thai
                        m: w.cn || w.m || '',   // å…¼å®¹æ—§ key: cn
                        s: w.rom || w.s || '',
                        c: w.category || w.c || 'é»˜è®¤', // å…¼å®¹æ—§ key: category
                        k: w.known || w.k || false
                    }));
                    saveData(); // ç«‹å³ä¿å­˜æ–°æ ¼å¼
                } else {
                    appData = temp; // æ ¼å¼æ­£ç¡®ï¼Œç›´æ¥ç”¨
                }
            } else {
                appData = { cats: ['é»˜è®¤'], words: [] };
            }
            
            // ç¡®ä¿ç›®å½•å®‰å…¨
            if (!appData.cats || !appData.cats.length) appData.cats = ['é»˜è®¤'];
            
            // å°è¯•æ¢å¤ä¸Šæ¬¡åœç•™çš„ç›®å½•ï¼Œå¦‚æœä¸å­˜åœ¨åˆ™å›æ»šåˆ°ç¬¬ä¸€ä¸ª
            if (!appData.cats.includes(currCat)) currCat = appData.cats[0];

            renderCats();
            renderList();
        }

        function saveData() { localStorage.setItem(CONFIG[currLang].storeKey, JSON.stringify(appData)); }

        // --- ç›®å½•æ“ä½œ (å·²ä¿®å¤åŒæ­¥é—®é¢˜) ---
        function renderCats() {
            const sel = document.getElementById('categorySelect');
            sel.innerHTML = '';
            appData.cats.forEach(c => {
                const opt = document.createElement('option');
                opt.value = c; opt.text = c;
                sel.appendChild(opt);
            });
            // æ˜¾å¼èµ‹å€¼ï¼Œç¡®ä¿ UI åŒæ­¥
            sel.value = currCat;
        }

        function changeCategory() {
            currCat = document.getElementById('categorySelect').value;
            renderList();
        }

        function addCategory() {
            let n = prompt("è¯·è¾“å…¥æ–°ç›®å½•åç§°:");
            if (n) {
                n = n.trim(); // å»é™¤é¦–å°¾ç©ºæ ¼
                if (n && !appData.cats.includes(n)) {
                    appData.cats.push(n);
                    currCat = n; // åˆ‡æ¢åˆ°æ–°ç›®å½•
                    saveData();
                    renderCats(); // åˆ·æ–°ä¸‹æ‹‰æ¡†
                    renderList(); // åˆ·æ–°åˆ—è¡¨
                } else if (appData.cats.includes(n)) {
                    alert("ç›®å½•å·²å­˜åœ¨");
                }
            }
        }

        // --- åˆ—è¡¨ä¸ CRUD ---
        function handleEnter(e) { if(e.key === 'Enter') addWord(); }

        async function addWord() {
            const m = document.getElementById('inpMain').value.trim();
            const s = document.getElementById('inpSub').value.trim();
            let c = document.getElementById('inpMean').value.trim();
            if (!m) return;
            
            if (!c) {
                const btn = document.getElementById('addBtn');
                const old = btn.innerText; btn.innerText="...";
                try {
                    const res = await fetch(`https://api.mymemory.translated.net/get?q=${encodeURIComponent(m)}&langpair=${CONFIG[currLang].trans}`);
                    const d = await res.json();
                    if(d.responseData?.translatedText) c = d.responseData.translatedText;
                } catch(e){}
                btn.innerText=old;
            }

            appData.words.push({ t:m, s:s, m:c, c:currCat, k:false });
            saveData();
            document.getElementById('inpMain').value=''; document.getElementById('inpSub').value=''; document.getElementById('inpMean').value='';
            document.getElementById('inpMain').focus();
            renderList(); speak(m);
        }

        function renderList() {
            const list = document.getElementById('wordList');
            list.innerHTML = '';
            list.className = isHide ? 'hide-mode' : '';

            let data = appData.words.filter(w => w.c === currCat);
            if(isFilter) data = data.filter(w => !w.k);
            data.sort((a,b) => (a.k===b.k)?0:a.k?1:-1);

            document.getElementById('countDisplay').innerText = data.length;

            data.forEach(item => {
                const div = document.createElement('div');
                div.className = `word-item ${item.k?'known':''}`;
                div.innerHTML = `
                    <div style="flex-grow:1" onclick="speak('${item.t}')">
                        <div class="main-text">${item.t}</div>
                        ${item.s?`<div class="sub-text">[${item.s}]</div>`:''}
                        <div class="mean-text">${item.m}</div>
                    </div>
                    <div style="display:flex;flex-direction:column;gap:5px;">
                        <button class="btn-action" style="${item.k?'background:var(--primary);color:white':''}" onclick="toggleKnown('${item.t}')">âœ”</button>
                        <button class="btn-action" onclick="delWord('${item.t}')">âœ•</button>
                    </div>
                `;
                list.appendChild(div);
            });
        }

        function toggleKnown(txt) {
            const w = appData.words.find(x => x.t === txt && x.c === currCat);
            if(w) { w.k = !w.k; saveData(); renderList(); }
        }
        function delWord(txt) {
            if(confirm('åˆ é™¤?')) {
                const idx = appData.words.findIndex(x => x.t === txt && x.c === currCat);
                if(idx>-1) { appData.words.splice(idx,1); saveData(); renderList(); }
            }
        }
        function toggleMode() { isHide=!isHide; renderList(); document.getElementById('modeBtn').classList.toggle('active'); }
        function toggleFilter() { isFilter=!isFilter; renderList(); document.getElementById('filterBtn').classList.toggle('active'); }
        function speak(t) { const u=new SpeechSynthesisUtterance(t); u.lang=CONFIG[currLang].tts; u.rate=0.85; window.speechSynthesis.speak(u); }

        // --- äº‘åŒæ­¥ & é¢„ç½® ---
        function importSeedData() {
            if(!confirm(`å¯¼å…¥${CONFIG[currLang].name}æ•‘å‘½å£è¯­?`)) return;
            CONFIG[currLang].seed.forEach(s => {
                if(!appData.cats.includes(s.c)) appData.cats.push(s.c);
                if(!appData.words.some(w => w.t === s.t)) appData.words.push({t:s.t,s:s.s,m:s.m,c:s.c,k:false});
            });
            saveData(); renderCats(); renderList(); alert("å¯¼å…¥æˆåŠŸ");
        }
        function saveCloudConfig() {
            cloudCfg.token = document.getElementById('ghToken').value.trim();
            cloudCfg.gistId = document.getElementById('ghGistId').value.trim();
            localStorage.setItem('cloudCfg', JSON.stringify(cloudCfg));
        }
        async function syncToCloud() {
            if(!cloudCfg.token) return alert("æ—  Token");
            document.getElementById('syncStatus').innerText = "â³";
            const file = CONFIG[currLang].file;
            const payload = { description: "Thai/Cantonese Backup", public: false, files: { [file]: { content: JSON.stringify(appData) } } };
            let url = "https://api.github.com/gists", method = "POST";
            if(cloudCfg.gistId) { url += "/" + cloudCfg.gistId; method = "PATCH"; }
            try {
                const res = await fetch(url, { method, headers: { "Authorization": `token ${cloudCfg.token}` }, body: JSON.stringify(payload) });
                const d = await res.json();
                if(!cloudCfg.gistId) { cloudCfg.gistId = d.id; document.getElementById('ghGistId').value = d.id; saveCloudConfig(); }
                document.getElementById('syncStatus').innerText = "âœ… OK " + new Date().toLocaleTimeString();
            } catch(e) { alert("Fail"); }
        }
        async function syncFromCloud() {
            if(!cloudCfg.gistId) return alert("æ—  Gist ID");
            document.getElementById('syncStatus').innerText = "â³";
            try {
                const res = await fetch(`https://api.github.com/gists/${cloudCfg.gistId}`, { headers: { "Authorization": `token ${cloudCfg.token}` } });
                const d = await res.json();
                const file = CONFIG[currLang].file;
                if(d.files && d.files[file]) {
                    if(confirm("è¦†ç›–æœ¬åœ°?")) {
                        appData = JSON.parse(d.files[file].content); saveData(); renderCats(); renderList();
                        document.getElementById('syncStatus').innerText = "âœ… OK";
                    }
                } else alert("äº‘ç«¯æ— æ•°æ®");
            } catch(e) { alert("Fail"); }
        }

        init();
    </script>
</body>
</html>